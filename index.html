<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>cms.instructure.com</title>
<link href="https://fonts.cdnfonts.com/css/inter" rel="stylesheet">
<style>
/* ---------------------------------------------------- */
/* 1. Global styling & colours */
:root{
  --font:'Inter',sans-serif;
  --radius:6px;
  --wrapper:680px;
  --bg:#fafafa;
  --primary:#28a745;
  --primary-d:#218838;
  --white:#fff;
  --gray:#f6f6f6;
  --dark:#222;
  --red:#d32f2f;
  --blue:#1976d2;
  --purple:#7b1fa2;
}
body.dark{
  --bg:#222;
  --dark:#fafafa;
  --white:#222;
  --gray:#333;
}
/* ---------------------------------------------------- */
/* 2. Reset & base layout */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:var(--font);background:var(--bg);color:var(--dark);
  display:flex;justify-content:center;align-items:center;
  min-height:100vh;overflow:hidden;}
ul{list-style:disc;padding-left:1.3rem;}
/* ---------------------------------------------------- */
/* 3. Login card */
.card{
  position:relative;background:var(--white);border-radius:var(--radius);
  box-shadow:0 4px 12px rgba(0,0,0,.08);padding:2rem;
  width:100%;max-width:440px;text-align:center;
  transition:background .3s,box-shadow .3s;}
h2{margin-bottom:1rem;font-size:1.8rem;color:var(--primary);}
h3{margin:.7rem 0;font-size:.95rem;color:#555;}
.input{
  width:100%;padding:.8rem 1rem;margin:1rem 0;
  font-size:.95rem;border:1px solid #ccc;border-radius:var(--radius);
  transition:border-color .2s,box-shadow .2s;}
.input:focus{
  outline:none;border-color:var(--primary);
  box-shadow:0 0 4px var(--primary);}
.btn{
  width:100%;padding:.8rem 1rem;font-size:.95rem;
  color:#fff;background:var(--primary);border:none;
  border-radius:var(--radius);cursor:pointer;
  transition:background .2s,transform .1s;}
.btn:hover{background:var(--primary-d);transform:scale(1.02);}

/* Theme toggle button (small) */
button.smallBtn{background:#6c757d;color:#fff;padding:.4rem .8rem;
  border:none;border-radius:6px;margin:0 .3rem;cursor:pointer;font-size:.85rem;}
button.smallBtn:hover{background:#5a6268;}
#msg{min-height:1.8rem;margin-top:.75rem;padding:.5rem 1rem;
  border-radius:var(--radius);font-size:.9rem;
  display:flex;justify-content:center;align-items:center;}
#msg.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
/* ---------------------------------------------------- */
/* 4. Loading spinner */
#spinner{display:none;margin:1rem auto;text-align:center;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}

/* ---------------------------------------------------- */
/* 5. Post‚Äëlogin wrapper & vault */
#wrapper{max-width:var(--wrapper);margin:auto;display:flex;
 flex-direction:column;align-items:center;gap:1rem;}
pre{background:var(--gray);border-radius:4px;padding:.5rem;
 width:90%;overflow-x:auto;white-space:pre-wrap;}
input.urlInput{width:90%;border-radius:4px;border:1px solid #ccc;
 padding:.45rem;margin:.5rem 0;font-size:.95rem;}
.tier{display:inline-block;padding:.25rem .65rem;margin:6px 0;
 color:#fff;font-size:.75rem;border-radius:4px;}
.tier.overlord{background:var(--red);}
.tier.standard{background:var(--blue);}
.tier.friend{background:var(--purple);}
.tier.gold{background:#ffc107;}
.tier.silver{background:#cfd8dc;}
.tier.bronze{background:#795548;}
.tier.Owner{background:#66e3ff;font-size:80px;
font-weight:bold;
background: linear-gradient(90deg, #000000 0%, #1a1a1a 50%, #000000 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
text-shadow: 0 0 5px #000000,0 0 10px #000000,0 0 15px #111;}
.tier.Owner:hover{text-shadow:0 0 10px #0ff,0 0 20px #0ff,0 0 30px #0ff,0 0 50px #0ff;transform:scale(1.05);
transition:all .3s ease;}
.features{width:90%;text-align:left;max-width:500px;
 background:var(--gray);border-radius:6px;padding:1rem;
 box-shadow:0 2x8px rgba(0,0,0,.05);}
.features h4{margin-bottom:.5rem;}
.features ul{margin:0;}
#vault{background:#f9f9f9;border-radius:6px;padding:1rem;
 box-shadow:0 2px 6px rgba(0,0,0,.1);display:none;max-width:440px;}
#vault h3{margin-bottom:.8rem;font-size:1.2rem;color:var(--primary);}
#vault ul{max-height:200px;overflow-y:auto;margin-top:1rem;
 list-style:none;padding:0;}
.keyItem{display:flex;justify-content:space-between;align-items:center;
 padding:.4rem .6rem;border-radius:4px;margin:4px 0;
 background:var(--white);box-shadow:0 1px 3px rgba(0,0,0,.1);}
.keyName{font-weight:600;}
.keyDetails{font-size:.9rem;color:#555;margin-left:1rem;}
.keyItem button{background:#e53935;color:#fff;font-size:.7rem;padding:.2rem .4rem;
 border:none;border-radius:4px;cursor:pointer;}
.keyItem button:hover{background:#d32f2f;}

/* ---------------------------------------------------- */
/* 6. Server status & updates */
#serverStatus, #serverUpdates{background:var(--gray);border-radius:6px;padding:1rem;
 margin-top:1rem;width:90%;max-width:440px;}
#serverUpdates ul{list-style:none;padding:0;}
#serverUpdates li{margin-bottom:.5rem;padding:.5rem;background:var(--white);
 border-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.1);}
</style>
</head>

<!-- WebSocket Message Broadcast - Embed Code -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
(function() {
    // Connect to the WebSocket server
    const socket = io('http://broadcastadmin.fischyweb.com');
    
    let messageBubble = null;
    
    // Create the floating message bubble
    function createBubble(message, shutdownNotice) {
        // Remove existing bubble if any
        if (messageBubble) {
            messageBubble.remove();
        }
        
        // Don't create bubble if no message
        if (!message && !shutdownNotice) return;
        
        // Create bubble element
        messageBubble = document.createElement('div');
        messageBubble.id = 'ws-message-bubble';
        
        // Style the bubble
        messageBubble.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 999999;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            animation: slideIn 0.5s ease-out;
        `;
        
        // Build content
        let content = '';
        if (message) {
            content += `<div style="font-size: 14px; line-height: 1.6; margin-bottom: ${shutdownNotice ? '12px' : '0'};">${escapeHtml(message)}</div>`;
        }
        if (shutdownNotice) {
            content += `<div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; font-size: 13px; border-left: 3px solid #ffc107;">‚ö†Ô∏è ${escapeHtml(shutdownNotice)}</div>`;
        }
        
        // Add close button
        content += `<button onclick="this.parentElement.remove()" style="
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: background 0.3s;
        " onmouseover="this.style.background='rgba(255,255,255,0.5)'" onmouseout="this.style.background='rgba(255,255,255,0.3)'">√ó</button>`;
        
        messageBubble.innerHTML = content;
        
        // Add animation keyframes
        if (!document.getElementById('ws-bubble-styles')) {
            const style = document.createElement('style');
            style.id = 'ws-bubble-styles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(450px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Add to page
        document.body.appendChild(messageBubble);
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Listen for broadcast messages
    socket.on('broadcast_message', function(data) {
        console.log('üì¢ Received broadcast message:', data);
        createBubble(data.message, data.shutdown_notice);
    });
    
    // Listen for clear message event
    socket.on('clear_messages', function() {
        console.log('üóëÔ∏è Messages cleared');
        if (messageBubble) {
            messageBubble.remove();
            messageBubble = null;
        }
    });
    
    // Request last message when connected
    socket.on('connect', function() {
        console.log('‚úÖ Connected to WebSocket server');
        socket.emit('request_last_message');
    });
    
    // Receive last message (for persistence)
    socket.on('last_message', function(data) {
        if (data.message || data.shutdown_notice) {
            createBubble(data.message, data.shutdown_notice);
        }
    });
    
    socket.on('disconnect', function() {
        console.log('‚ùå Disconnected from WebSocket server');
    });
})();
</script>
  
<body>
<!-- Login -->
<div class="card" id="auth">
  <h2>Authenticate</h2>
  <button id="themeToggle" class="smallBtn" title="Toggle theme">üåô</button>
  <h3>If you want to buy a key, email 5137455873@student.cms.k12.nc.us, and he will give you a invoice</h3>
  <input type="text" id="keyInput" class="input" placeholder="Enter your key">
  <button id="authBtn" class="btn">Authenticate</button>
  <div id="msg" role="alert"></div>
</div>

<!-- Loading spinner -->
<div id="spinner">
  <svg width="32" height="32" viewBox="0 0 50 50" style="animation:spin .7s linear infinite;">
    <circle cx="25" cy="25" r="20" fill="none" stroke="#28a745" stroke-width="6"/>
  </svg>
</div>

<!-- Server status -->
<div id="serverStatus" style="display:none;">
  <h3>Server Status</h3>
  <p>Health: <span id="srvHealth"></span></p>
  <p>Uptime: <span id="srvUptime"></span></p>
  <p>CPU: <span id="srvCPU"></span>%</p>
  <p>Memory: <span id="srvMem"></span>%</p>
  <p>User Count: <span id="srvUsers"></span></p>
</div>

<!-- Server updates -->
<div id="serverUpdates" style="display:none;">
  <h3>Server Updates</h3>
  <ul id="updatesList"></ul>
</div>

<script>
const SERVER_URL = "https://keyserver.fischyweb.com/";
let keyList = [];
let currentKey = null; // authenticated key

const RANKS = [
  {id:"overlord", name:"Overlord", features:["Unlimited access","Priority support","2FA by default","Custom branding"]},
  {id:"standard", name:"Standard", features:["Core modules","48‚Äëh support","Basic analytics"]},
  {id:"friend", name:"Friend", features:["Limited modules","Community forums","No priority"]},
  {id:"gold", name:"Gold", features:["Priority support","Advanced analytics"]},
  {id:"silver", name:"Silver", features:["Basic analytics","Community support"]},
  {id:"bronze", name:"Bronze", features:["Basic modules","Community forums"]},
  {id:"Owner", name:"Owner", features:["Basic modules","Community forums"]},
];

// --------------------------------------------------------------------------
// SHA-256 helper
async function sha256Hex(str){
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash))
    .map(b=>b.toString(16).padStart(2,'0')).join('');
}

// --------------------------------------------------------------------------
// Fetch server status & updates
async function fetchStatus(){
  try{
    const res = await fetch(SERVER_URL+"/api/status");
    const data = await res.json();
    document.getElementById("srvHealth").textContent = data.health;
    document.getElementById("srvUptime").textContent = data.uptime_seconds+"s";
    document.getElementById("srvCPU").textContent = data.cpu_percent;
    document.getElementById("srvMem").textContent = data.memory_percent;
    document.getElementById("srvUsers").textContent = data.user_count;
    document.getElementById("serverStatus").style.display="block";
  }catch(e){ console.log("Cannot reach server:", e); }
}
async function fetchUpdates(){
  try{
    const res = await fetch(SERVER_URL+"/api/updates");
    const data = await res.json();
    const ul = document.getElementById("updatesList");
    ul.innerHTML="";
    data.slice().reverse().forEach(u=>{
      const li=document.createElement("li");
      li.innerHTML=`<strong>${u.title}</strong><br>${u.message}`;
      ul.appendChild(li);
    });
    document.getElementById("serverUpdates").style.display="block";
  }catch(e){ console.log("Cannot fetch updates:", e); }
}
setInterval(fetchStatus,5000);
setInterval(fetchUpdates,10000);
fetchStatus();
fetchUpdates();

// --------------------------------------------------------------------------
// Key Vault
function loadVault(){ return localStorage.getItem('keyVault')? JSON.parse(localStorage.getItem('keyVault')): [];}
function saveVault(v){ localStorage.setItem('keyVault',JSON.stringify(v));}
function renderVault(){
  const vault = loadVault();
  const ul = document.getElementById('keyList');
  if(!ul) return;
  ul.innerHTML='';
  vault.forEach((k, idx)=>{
    const li=document.createElement('li');li.className='keyItem';
    li.innerHTML=`<strong class="keyName">${k.name||'Unnamed'}</strong>
                  <span class="keyDetails">${k.tier} ‚Äì added ${new Date(k.addedAt).toLocaleString()}</span>
                  <button class="delBtn" data-i="${idx}" title="Remove">&times;</button>`;
    ul.appendChild(li);
  });
}
function promptAddKey(){
  const raw = prompt('Enter the key you want to store (leave blank to cancel)');
  if (!raw) return;
  const name = prompt('Optional: give this key a name')||'';
  if (!/^[a-f0-9]{64}$/.test(raw)){
    alert('Invalid key ‚Äì must be 64 hex characters.');
    return;
  }
  const tier = raw.split('_')[0]||'Standard';
  const vault = loadVault();
  vault.push({hash:raw,name,tier,addedAt:Date.now()});
  saveVault(vault);
  renderVault();
}
function deleteKey(i){
  if (!confirm('Delete this key?')) return;
  const vault = loadVault();
  vault.splice(i,1);
  saveVault(vault);
  renderVault();
}

// --------------------------------------------------------------------------
// Open URL in about:blank
function openCustomPage(url, watermarkEnabled, watermarkRank){
  if(!url){alert('Enter a URL.');return;}
  const win=window.open('about:blank','_blank');
  if(!win){alert('Pop-ups blocked.');return;}
  const watermarkHTML = watermarkEnabled?`
    <div id="wmContainer">
      <div id="wm">FISCHY HIDER</div>
      <span class="wmRank">${watermarkRank}</span>
    </div>`:'';
  win.document.write(`
    <!doctype html>
    <html lang="en"><head><meta charset="utf-8"><title>cms.instructure.com</title>
    <style>
      html,body{margin:0;padding:0;font-family:Inter,sans-serif;background:#fff;}
      iframe{border:none;width:100%;height:100vh;}
      #wmContainer{position:fixed;top:50%;right:10px;transform:translateY(-50%);
        display:flex;align-items:center;z-index:9999;}
      #wm{font-size:48px;color:rgba(200,200,200,.6);transform:rotate(90deg);font-weight:bold;}
      .wmRank{font-size:20px;color:#222;margin-left:15px;transform:rotate(-90deg);}
    </style></head>
    <body>${watermarkHTML}<iframe src="${url}"></iframe></body></html>
  `);
  win.document.close();
}

// --------------------------------------------------------------------------
// Show welcome page
async function showWelcome(userData, loggedAsFriend){
  const friendKey = await sha256Hex(userData.name+"_Friend_Key");
  const title = loggedAsFriend?`${userData.name} ‚Äì Friend`:userData.name;
  const rank = RANKS.find(r=>r.id===userData.rank)||{name:"Unknown",features:[]};
  const keyBlock = loggedAsFriend?'':`
    <h3>Your key (Friend key to use):</h3>
    <pre id="friendKey">${friendKey}</pre>
    <button class="smallBtn" id="copyFriendBtn">Copy Key</button>`;
  const featList = rank.features.map(f=>`<li>${f}</li>`).join('');
  const featureBlock = `<div class="features"><h4>Tier Features (${rank.name})</h4><ul>${featList}</ul></div>`;
  const goodRanks=['overlord','Owner'];
  let wmEnabled=false;

  document.body.innerHTML=`
    <div id="wrapper">
      <h1>Welcome, ${title}!</h1>
      <h2>Tier: <span class="tier ${userData.rank}">${rank.name}</span></h2>
      ${keyBlock}
      <input type="text" id="urlInput" class="urlInput" placeholder="Enter a URL to view in about:blank">
      <button class="smallBtn" id="openUrlBtn">press me to Hide it</button>
      <div style="margin-top:1rem;">
        <p>This rank ${goodRanks.includes(userData.rank)?'can toggle the watermark':'always shows a watermark'}.</p>
      </div>
      ${featureBlock}
      <button class="smallBtn" id="againBtn">Authenticate again</button>
    </div>
    <div id="vault">
      <h3>My Key Vault</h3>
      <button class="smallBtn" id="addKeyBtn">Add Key</button>
      <ul id="keyList"></ul>
    </div>
  `;

  if(goodRanks.includes(userData.rank)){
    const toggleBtn=document.createElement('button');
    toggleBtn.className='smallBtn';
    toggleBtn.textContent='Show Watermark';
    toggleBtn.onclick=()=>{ wmEnabled=!wmEnabled; toggleBtn.textContent=wmEnabled?'Hide Watermark':'Show Watermark'; };
    document.getElementById('wrapper').appendChild(toggleBtn);
  }

  if(!loggedAsFriend){
    document.getElementById('copyFriendBtn').onclick=()=>navigator.clipboard.writeText(friendKey).then(()=>alert('Key copied!'));
  }

  document.getElementById('openUrlBtn').onclick=()=>{ 
    const url=document.getElementById('urlInput').value.trim();
    openCustomPage(url, !goodRanks.includes(userData.rank)||wmEnabled, rank.name);
  };

  renderVault();
  document.getElementById('addKeyBtn').onclick=promptAddKey;
  document.getElementById('keyList').addEventListener('click',e=>{
    if(e.target.classList.contains('delBtn')) deleteKey(parseInt(e.target.dataset.i));
  });
  document.getElementById('againBtn').onclick=()=>location.reload();
}

// --------------------------------------------------------------------------
// Fetch key list
async function fetchKeyList(){
  const sp = document.getElementById('spinner');
  const msg= document.getElementById('msg');
  sp.style.display='block';
  try{
    const res = await fetch(SERVER_URL+"/api/keys",{mode:'cors'});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    keyList = await res.json();
    console.log('Key list fetched:', keyList);
  }catch(e){
    console.error('Unable to fetch key list:', e);
    msg.className='error'; msg.textContent='Unable to reach key list. Try again.';
  }finally{ sp.style.display='none'; }
}

// --------------------------------------------------------------------------
// Live key revocation
async function liveKeyCheck(){
  if(!currentKey) return;
  try{
    const res = await fetch(SERVER_URL+"/api/keys");
    const latestKeys = await res.json();
    const found = latestKeys.find(k=>k.main===currentKey||k.friend===currentKey);
    if(!found){
      alert("Your key has been removed! Logging out.");
      localStorage.removeItem('keyVault');
      location.reload();
    }
  }catch(e){ console.log("Key check failed:", e); }
}
setInterval(liveKeyCheck,3000);

// --------------------------------------------------------------------------
// Login logic
async function doLogin(){
  const key = document.getElementById('keyInput').value.trim();
  const msg = document.getElementById('msg');
  if(!key){ msg.className='error'; msg.textContent='Enter a key.'; return; }
  msg.textContent=''; msg.className='';
  await fetchKeyList();
  if(!Array.isArray(keyList)||keyList.length===0){ msg.className='error'; msg.textContent='Key list empty.'; return; }
  const matched = keyList.find(k=>k.main===key||k.friend===key);
  if(!matched){ msg.className='error'; msg.textContent='Unknown key.'; return; }
  currentKey = key;
  showWelcome(matched,false);
}

document.getElementById('authBtn').onclick=doLogin;
document.getElementById('keyInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){doLogin(); e.preventDefault();} });

// --------------------------------------------------------------------------
// Theme switcher
function updateThemeIcon(){ document.getElementById('themeToggle').textContent = document.body.classList.contains('dark')?'‚òÄÔ∏è':'üåô'; }
function toggleTheme(){ document.body.classList.toggle('dark'); localStorage.setItem('darkMode',document.body.classList.contains('dark')); updateThemeIcon(); }
window.addEventListener('load',()=>{ if(localStorage.getItem('darkMode')==='true') toggleTheme(); else updateThemeIcon(); });
document.getElementById('themeToggle').onclick=toggleTheme;
</script>
</body>
</html>
